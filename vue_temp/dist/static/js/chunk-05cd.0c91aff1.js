(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-05cd"],{"8LGB":function(t,e,a){"use strict";a.r(e);var i=a("fe1z"),r=a("d5rn"),l={name:"AuditTable",props:{worklist:{type:Array,require:!0,default:function(){return[]}}},data:function(){return{gridData:[],listQuery:{work_id:0},dialogExecResVisible:!1,dialogSqlDetail:!1,sqldetail:!1,disabled:!1,dialogFormVisible:!1,work_id:0,form:{exec_timepoint:"1",exec_way:"1",work_status:2},pickerOptions1:{disabledDate:function(t){return t.getTime()>Date.now()},shortcuts:[{text:"今天",onClick:function(t){t.$emit("pick",new Date)}},{text:"明天",onClick:function(t){var e=new Date;e.setTime(e.getTime()+864e5),t.$emit("pick",e)}}]},formLabelWidth:"120px",userrole:0,param:{datas:{work_status:0},id:0},activeName:"1",list:null,flag:!0}},created:function(){this.getUserInfo()},methods:{handleSqlDetail:function(t){this.dialogSqlDetail=!0,this.sqldetail=t.replace(/\n/g,"<br/>")},handleWay:function(t){2===t&&(this.form.exec_timepoint=0)},through_Action:function(){this.param.id=this.work_id,this.param.datas=this.form,this.$emit("upWorkstatus",this.param),this.dialogFormVisible=!1},getUserInfo:function(){var t=this;Object(i.a)().then(function(e){"admin"===e.roles[0]&&(t.userrole=1)})},through_func:function(t){this.param.datas.work_status=1,this.param.id=t,this.$emit("upWorkstatus",this.param)},rejected_func:function(t){this.param.datas.work_status=-1,this.param.id=t,this.$emit("upWorkstatus",this.param)},handleExecResDetail:function(t,e){var a=this;this.work_id=t,this.dialogExecResVisible=!0,this.listQuery.work_id=e,Object(r.b)(this.listQuery).then(function(t){a.gridData=t})},formatter:function(t){var e=t.work_id,a=new Date(1e3*e),i=a.getFullYear(),r=a.getMonth()+1,l=a.getDate(),o=a.getHours(),s=a.getMinutes(),n=a.getSeconds();return s<10?i+"-"+r+"-"+l+" "+o+":"+("0"+s)+":"+n:o<10?i+"-"+r+"-"+l+" "+("0"+o)+":"+s+":"+n:n<10?i+"-"+r+"-"+l+" "+o+":"+s+":"+("0"+n):i+"-"+r+"-"+l+" "+o+":"+s+":"+n}}},o=a("KHd+"),s=Object(o.a)(l,function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-table",{staticStyle:{width:"100%"},attrs:{data:t.worklist[0],"default-sort":{prop:"work_id",order:"descending"},"element-loading-text":"Loading",border:"",fit:"","highlight-current-row":""}},[a("el-table-column",{attrs:{formatter:t.formatter,label:"DateTime",prop:"work_id",align:"center",sortable:""}}),t._v(" "),a("el-table-column",{attrs:{label:"工单标题",prop:"workname",align:"left"}}),t._v(" "),a("el-table-column",{attrs:{label:"实例",prop:"instance",align:"left"}}),t._v(" "),a("el-table-column",{attrs:{label:"数据库名",prop:"db_name",align:"left"}}),t._v(" "),a("el-table-column",{attrs:{label:"执行语句",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("el-button",{attrs:{size:"small",type:"text",icon:"el-icon-info"},on:{click:function(a){t.handleSqlDetail(e.row.db_sql)}}},[t._v("详细")])]}}])}),t._v(" "),a("el-table-column",{attrs:{label:"发起者",width:"150",align:"center",prop:"author"}}),t._v(" "),a("el-table-column",{attrs:{label:"审批人",width:"150",align:"center",prop:"auditor"}}),t._v(" "),a("el-table-column",{attrs:{label:"执行人",width:"150",align:"center",prop:"dba"}}),t._v(" "),a("el-table-column",{attrs:{label:"工单状态",width:"150",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[0===e.row.work_status?a("el-tag",{attrs:{type:"info"}},[t._v("等待审核")]):t._e(),t._v(" "),1===e.row.work_status?a("el-tag",{attrs:{type:"warning"}},[t._v("等待执行")]):t._e(),t._v(" "),2===e.row.work_status?a("el-tag",{attrs:{type:"success"}},[t._v("后台操作中")]):t._e(),t._v(" "),3===e.row.work_status?a("el-tag",{attrs:{type:"success"}},[t._v("工单完成")]):t._e(),t._v(" "),-1===e.row.work_status?a("el-tag",{attrs:{type:"danger"}},[t._v("已被驳回")]):t._e()]}}])}),t._v(" "),a("el-table-column",{attrs:{label:"操作&详情",width:"150",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[1===t.worklist[1]&&1===e.row.work_status?a("el-button",{attrs:{click:t.work_id=e.row.id,type:"success",size:"mini",icon:"el-icon-check",circle:""},on:{click:function(e){t.dialogFormVisible=!0}}}):t._e(),t._v(" "),1===t.worklist[1]&&1===e.row.work_status?a("el-button",{attrs:{type:"danger",size:"mini",icon:"el-icon-close",circle:""},on:{click:function(a){t.rejected_func(e.row.id)}}}):t._e(),t._v(" "),0===t.worklist[1]&&0===e.row.work_status?a("el-button",{attrs:{type:"success",size:"mini",icon:"el-icon-check",circle:""},on:{click:function(a){t.through_func(e.row.id)}}}):t._e(),t._v(" "),0===t.worklist[1]&&0===e.row.work_status?a("el-button",{attrs:{type:"danger",size:"mini",icon:"el-icon-close",circle:""},on:{click:function(a){t.rejected_func(e.row.id)}}}):t._e(),t._v(" "),e.row.work_status<=-1?a("el-popover",{attrs:{placement:"right",width:"300",trigger:"click"}},[a("div",{attrs:{align:"left"},domProps:{innerHTML:t._s(e.row.rejected_note)}},[t._v(".")]),t._v(" "),a("el-button",{attrs:{slot:"reference",size:"mini",type:"text",icon:"el-icon-info"},slot:"reference"},[t._v("驳回原因")])],1):t._e(),t._v(" "),3===e.row.work_status?a("el-button",{attrs:{size:"small",type:"text",icon:"el-icon-info"},on:{click:function(a){t.handleExecResDetail(e.row.id,e.row.work_id)}}},[t._v("执行结果")]):t._e(),t._v(" "),a("el-dialog",{attrs:{visible:t.dialogFormVisible,title:"提交任务",width:"30%"},on:{"update:visible":function(e){t.dialogFormVisible=e}}},[a("el-form",{attrs:{model:t.form}},[a("el-form-item",{attrs:{"label-width":t.formLabelWidth,label:"执行方式",align:"left"}},[a("el-radio-group",{model:{value:t.form.exec_way,callback:function(e){t.$set(t.form,"exec_way",e)},expression:"form.exec_way"}},[a("el-radio",{attrs:{label:"1"}},[t._v("自动执行")]),t._v(" "),a("el-radio",{attrs:{label:"2"},nativeOn:{click:function(e){t.handleWay(2)}}},[t._v("手动执行")])],1)],1),t._v(" "),"1"===t.form.exec_way?a("el-form-item",{attrs:{"label-width":t.formLabelWidth,label:"选择时段",align:"left"}},[a("el-radio-group",{model:{value:t.form.exec_timepoint,callback:function(e){t.$set(t.form,"exec_timepoint",e)},expression:"form.exec_timepoint"}},[a("el-radio",{attrs:{label:"1"}},[t._v("立即执行")]),t._v(" "),a("el-radio",{attrs:{label:"2"}},[t._v("明日凌晨02:00后执行")])],1)],1):t._e()],1),t._v(" "),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:function(e){t.dialogFormVisible=!1}}},[t._v("取 消")]),t._v(" "),a("el-button",{attrs:{type:"primary"},on:{click:t.through_Action}},[t._v("确 定")])],1)],1)]}}])}),t._v(" "),a("el-dialog",{attrs:{"append-to-body":!0,visible:t.dialogExecResVisible,title:"执行结果",width:"70%"},on:{"update:visible":function(e){t.dialogExecResVisible=e}}},[a("el-table",{attrs:{data:t.gridData}},[a("el-table-column",{attrs:{property:"c_time",label:"执行完成时间",width:"150"}}),t._v(" "),a("el-table-column",{attrs:{label:"执行状态",width:"150"},scopedSlots:t._u([{key:"default",fn:function(e){return[1===e.row.exec_status?a("el-tag",{attrs:{type:"success"}},[t._v("执行成功")]):t._e(),t._v(" "),-1===e.row.exec_status?a("el-tag",{attrs:{type:"danger"}},[t._v("执行失败")]):t._e()]}}])}),t._v(" "),a("el-table-column",{attrs:{property:"errormessage",label:"错误信息",width:"200"}}),t._v(" "),a("el-table-column",{attrs:{property:"SQL",label:"SQL内容"}}),t._v(" "),1===t.worklist[1]?a("el-table-column",{attrs:{label:"操作"},scopedSlots:t._u([{key:"default",fn:function(e){return[-1===e.row.exec_status?a("el-button",{attrs:{size:"small",type:"danger",icon:"el-icon-warning"},on:{click:function(e){t.dialogFormVisible=!0}}},[t._v("重置任务")]):t._e()]}}])}):t._e()],1)],1),t._v(" "),a("el-dialog",{attrs:{"append-to-body":!0,visible:t.dialogSqlDetail,title:"SQL详情",width:"70%"},on:{"update:visible":function(e){t.dialogSqlDetail=e}}},[a("div",{attrs:{align:"left"},domProps:{innerHTML:t._s(t.sqldetail)}},[t._v(".")])])],1)},[],!1,null,null,null);s.options.__file="table.vue";var n={components:{TableDetail:s.exports},data:function(){return{row:"",username:"",userrole:"",work_status:"",currentPage1:1,pagesizes:[5,10,20,30,40],totalrows:0,listQuery:{page:1,page_size:10},audit:[],rejected:[],through:[],flag:!0}},created:function(){this.fetchData()},methods:{searchData:function(){this.listQuery.page=1,this.fetchData()},fetchData:function(t){var e=this;this.work_status!==t&&(this.listQuery.page=1),this.listQuery.work_status=t,this.work_status=t,Object(i.a)().then(function(t){e.username=t.name,e.userrole=t.roles[0],"admin"===e.userrole?Object(r.c)(e.listQuery).then(function(t){e.audit=[t.results],e.audit.splice(1,0,1),e.totalrows=t.count,e.next=t.next,e.previous=t.previous}):(e.listQuery.auditor=e.username,Object(r.c)(e.listQuery).then(function(t){e.audit=[t.results],e.audit.splice(1,0,0),e.totalrows=t.count}))})},upWorkstatus:function(t){var e=this;"admin"===this.userrole&&(t.datas.dba=this.username),1===t.datas.work_status||2===t.datas.work_status?Object(r.d)(t.id,t.datas).then(function(t){e.$message({title:"成功",message:"您已经批准执行该工单",type:"success"},e.fetchData())}):this.$prompt("请输入驳回理由","是否确认驳回？",{confirmButtonText:"确定",cancelButtonText:"取消"}).then(function(a){var i=a.value;"admin"===e.userrole?t.datas.rejected_note="管理员驳回:"+i:t.datas.rejected_note="审核员驳回:"+i,Object(r.d)(t.id,t.datas).then(function(t){e.$message({title:"成功",type:"success",message:"您选择驳回该工单"},e.fetchData())})}).catch(function(){e.$message({title:"取消",type:"info",message:"您选择撤销驳回"})})},handleCurrentChange:function(t){this.listQuery.page=t,this.fetchData(this.work_status)},handleSizeChange:function(t){this.listQuery.page_size=t,this.fetchData(this.work_status)}}},c=Object(o.a)(n,function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"app-container"},[a("div",{staticClass:"filter-container"},[a("el-input",{staticClass:"filter-item",staticStyle:{width:"200px"},attrs:{size:"small",placeholder:"工单标题",clearable:""},nativeOn:{keyup:function(e){if(!("button"in e)&&t._k(e.keyCode,"enter",13,e.key,"Enter"))return null;t.fetchData()}},model:{value:t.listQuery.workname,callback:function(e){t.$set(t.listQuery,"workname",e)},expression:"listQuery.workname"}}),t._v(" "),a("el-button",{staticClass:"filter-item",attrs:{size:"small",type:"primary",icon:"el-icon-search"},on:{click:t.searchData}},[t._v("搜&刷")]),t._v(" "),"auditor"===t.userrole?a("el-button",{staticClass:"filter-item",staticStyle:{"margin-left":"10px"},attrs:{size:"small",type:"primary",icon:"el-icon-check"},on:{click:function(e){t.fetchData(0)}}},[t._v("未审核")]):t._e(),t._v(" "),"admin"===t.userrole?a("el-button",{staticClass:"filter-item",staticStyle:{"margin-left":"10px"},attrs:{size:"small",type:"warning",icon:"el-icon-check"},on:{click:function(e){t.fetchData(1)}}},[t._v("未执行")]):t._e(),t._v(" "),a("el-button",{staticClass:"filter-item",staticStyle:{"margin-left":"10px"},attrs:{size:"small",type:"success",icon:"el-icon-check"},on:{click:function(e){t.fetchData(3)}}},[t._v("已完成")]),t._v(" "),a("el-button",{staticClass:"filter-item",staticStyle:{"margin-left":"10px"},attrs:{size:"small",type:"danger",icon:"el-icon-close"},on:{click:function(e){t.fetchData(-1)}}},[t._v("已驳回")])],1),t._v(" "),a("br"),t._v(" "),a("table-detail",{attrs:{worklist:t.audit},on:{upWorkstatus:t.upWorkstatus}}),t._v(" "),a("div",{staticClass:"block"},[a("el-pagination",{attrs:{"current-page":t.currentPage1,total:t.totalrows,"page-sizes":t.pagesizes,"page-size":t.listQuery.page_size,page:1,layout:"total, sizes, prev, pager, next,  jumper"},on:{"current-change":t.handleCurrentChange,"size-change":t.handleSizeChange}})],1)],1)},[],!1,null,null,null);c.options.__file="auditlist.vue";e.default=c.exports},d5rn:function(t,e,a){"use strict";a.d(e,"c",function(){return r}),a.d(e,"a",function(){return l}),a.d(e,"d",function(){return o}),a.d(e,"b",function(){return s});var i=a("t3Un");function r(t,e){return Object(i.a)({url:"/workorder/workinfo/",method:"get",params:t})}function l(t){return Object(i.a)({url:"/workorder/workinfo/",method:"post",data:t})}function o(t,e){return Object(i.a)({url:"/workorder/workinfo/"+t+"/",method:"put",data:e})}function s(t,e){return Object(i.a)({url:"/workorder/executeres/",method:"get",params:t})}}}]);